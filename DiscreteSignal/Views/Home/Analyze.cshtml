@{
    ViewData["Title"] = "Анализ аудио";
    var fileName = ViewData["FileName"]?.ToString();
}

<h1>Анализ аудио</h1>

<p>Файл: <strong>@fileName</strong></p>

<div>
    <label>
        Длина окна N:
        <input type="number" id="windowSize" value="1024" min="64" step="64" />
    </label>
    <label>
        Окно:
        <input type="number" id="windowIndex" value="0" min="0" />
    </label>
    <button id="btnAnalyze">Построить графики</button>
</div>

<div style="margin-top: 10px;">
    <label><input type="checkbox" id="showOriginal" checked> Показать исходный сигнал</label>
    <label style="margin-left: 10px;"><input type="checkbox" id="showIDFT" checked> Показать восстановленный сигнал (ОДПФ)</label>
</div>

<div style="margin-top: 20px;">
    <h3>Амплитудный спектр (ДПФ)</h3>
    <canvas id="spectrumChart" width="800" height="300"></canvas>
</div>

<div style="margin-top: 20px;">
    <h3>Временной сигнал (Исходный и ОДПФ)</h3>
    <canvas id="signalChart" width="800" height="300"></canvas>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        (() => {
            const fileName = "@fileName";
            const btnAnalyze = document.getElementById('btnAnalyze');
            const windowSizeInput = document.getElementById('windowSize');
            const windowIndexInput = document.getElementById('windowIndex');
            const showOriginalCheckbox = document.getElementById('showOriginal');
            const showIDFTCheckbox = document.getElementById('showIDFT');

            const spectrumCtx = document.getElementById('spectrumChart').getContext('2d');
            const signalCtx = document.getElementById('signalChart').getContext('2d');
            let spectrumChart, signalChart;
            let wavSamplesData, idftSignalData;

            async function fetchSpectrum(windowSize, windowIndex) {
                const resp = await fetch(`/GetDiscreteSpectrumWindow?fileName=${encodeURIComponent(fileName)}&windowIndex=${windowIndex}&windowSize=${windowSize}`);
                return await resp.json();
            }

            async function fetchInverseDFT(windowSize, windowIndex) {
                const resp = await fetch(`/GetInverseDFTWindow?fileName=${encodeURIComponent(fileName)}&windowIndex=${windowIndex}&windowSize=${windowSize}`);
                return await resp.json();
            }

            async function fetchWavSamples(fileName, windowSize, windowIndex) {
                const resp = await fetch(`/GetWavSamples?fileName=${encodeURIComponent(fileName)}`);
                const data = await resp.json();
                if (data.ok) {
                    const start = windowIndex * windowSize;
                    return data.samples.slice(start, start + windowSize);
                }
                return null;
            }

            function updateSignalChart() {
                if (!wavSamplesData || !idftSignalData) return;

                const samples = idftSignalData.map((_, i) => i);
                const datasets = [];

                if (showOriginalCheckbox.checked) {
                    datasets.push({
                        label: 'Исходный сигнал',
                        data: wavSamplesData,
                        borderColor: 'blue',
                        borderWidth: 1,
                        pointRadius: 0,
                        fill: false,
                        tension: 0
                    });
                }

                if (showIDFTCheckbox.checked) {
                    datasets.push({
                        label: 'Восстановленный сигнал (ОДПФ)',
                        data: idftSignalData,
                        borderColor: 'red',
                        borderWidth: 1,
                        pointRadius: 0,
                        fill: false,
                        tension: 0
                    });
                }

                if (signalChart) signalChart.destroy();
                signalChart = new Chart(signalCtx, {
                    type: 'line',
                    data: {
                        labels: samples,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: { title: { display: true, text: 'Время (сэмплы)' } },
                            y: { beginAtZero: true, title: { display: true, text: 'Амплитуда' } }
                        }
                    }
                });
            }

            async function drawCharts() {
                const windowSize = parseInt(windowSizeInput.value);
                const windowIndex = parseInt(windowIndexInput.value);

                const [spectrumData, signalData, wavSamples] = await Promise.all([
                    fetchSpectrum(windowSize, windowIndex),
                    fetchInverseDFT(windowSize, windowIndex),
                    fetchWavSamples(fileName, windowSize, windowIndex)
                ]);

                if (!spectrumData.ok || !signalData.ok || !wavSamples) {
                    alert('Ошибка анализа (ДПФ, ОДПФ или сэмплы WAV)');
                    return;
                }

                // Сохраняем данные для обновления графика
                wavSamplesData = wavSamples;
                idftSignalData = signalData.signal;

                // График спектра (ДПФ)
                const freqs = spectrumData.magnitudes.map((_, i) => i);
                if (spectrumChart) spectrumChart.destroy();
                spectrumChart = new Chart(spectrumCtx, {
                    type: 'line',
                    data: {
                        labels: freqs,
                        datasets: [{
                            label: 'Амплитуда',
                            data: spectrumData.magnitudes,
                            borderColor: 'blue',
                            borderWidth: 1,
                            pointRadius: 0,
                            fill: false,
                            tension: 0.2
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: { display: false },
                            y: { beginAtZero: true, title: { display: true, text: 'Амплитуда' } }
                        }
                    }
                });

                // График сигналов (Исходный и ОДПФ)
                updateSignalChart();
            }

            btnAnalyze.addEventListener('click', drawCharts);
            showOriginalCheckbox.addEventListener('change', updateSignalChart);
            showIDFTCheckbox.addEventListener('change', updateSignalChart);
        })();
    </script>
}